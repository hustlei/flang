# 词法

flang程序源代码使用unicode字符集，utf-8编码。

flang字符串支持所有的unicode字符。
flang非字符串代码支持除unicode类别Cs、Co、Cn、Cc之外的所有字符，
以及unicode类别Cc中的"Lf、Cr、\t、\v、\f"五个字符。

> unicode字符集类别简介见本文附件：字符集说明。

flang由源代码文件组成，词法是指定源文件文本如何组合字符以构成最基本的词法单元
如标记（标识符、文本、关键字、符号）、空白、注释、以及预处理指令的。

## 行结束符号

行结束符号将源码划分为不同的行。
行结束符包括：

- 回车符号Cr (U+000D)
- 换行符Lf (U+000A)
- 回车+换行符CrLf(U+000DU+000A)
- 下一行字符(U+0085)
- 行分隔字符(U+2028) unicode类别Zl目前唯一的字符
- 段分隔字符(U+2029) unicode类别Zp目前唯一的字符

用正则表达式表示为：`[\n\r\u{0085}\u{2028}\u{2029}]|\r\n`

> 本文用<newline>引用行结束符号。

## 空白

空白用于将标识符、文本字面量、符号等分隔开。
空白被定义为unicode类别Zs的任意字符以及水平制表符、垂直制表符或换页符：

- unicode类别Zs
- 水平制表符 (U+0009)
- 垂直制表符 (U+000B)
- 换页字符 (U+000C)

用正则表达式表示为：`[\p{Zs}\t\v\f]`


## 标识符

标识符用于表示变量、类型名、函数名等。

标识符用首字母必须是以下字符：

+ 下划线: _
+ 字母：unicode类别Lu、Ll、Lt、Lo、Nl

标识符非首字母可以是：

+ 下划线_
+ 字母：unicode类别Lu、Ll、Lt、Lm、Lo、Nl
+ 数字：unicode类别Nd
+ 修饰：unicode类别Mn、Mc、Sk
+ 连接字符：unicode类别Pc
+ 格式字符：unicode类别Cf

关键字不能作为标识符。

> 但是，在关键字前加`@`符号，可以将关键字作为标识符。比如：`var @var = 1`。主要用于调用其他语言库。

用正则表达式表示为：`[\p{Lu}\p{Ll}\p{Lt}\p{Lo}\p{Nl}_][\p{Lu}\p{Ll}\p{Lt}\p{Lo}\p{Nl}_\p{Lm}\p{Nd}\p{Mn}\p{Mc}\{Sk}\p{Pc}\p{Cf}]*`

## 关键字

~~~
use pub pri static

var let dynamic func op type impl trait defer msg act

ref as self Self super nil true false _ yield return

if elif else match for in while break continue

try catch finally throw
~~~

保留关键字

~~~
domain macro where Super
await async lazy co val ro
mut del new event rusume
typeof sizeof enum is
~~~

> 保留关键字待定，后期可能修改

## 文本

文本也称为字面量，包括Nil值，布尔值，整数，浮点数，复数，字符，字符串。

### Nil值

Nil表示空类型，Nil类型只有一个值，文本为

+ nil

用正则表达式表示为：`nil`

### 布尔值

布尔类型只有两个值，文本分别为：

+ true
+ false

用正则表达式表示为：`true|false`

### 整数

整数有二进制、十进制、十六进制三种文本表示方式：

十进制整数字面量格式如下：

1. 开始：+、-符号(可选)
2. 后跟：`0-9`的任意组合(至少一个字符)

用正则表达式表示`[+-]?[0-9]+`

> 本文用`<int>`引用十进制整数

二进制整数字母量格式如下：

1. 开始：+、-符号(可选)
2. 后跟：`0b`两个字符(必须)
3. 后跟：0、1的任意组合(至少一个字符)

用正则表达式表示`[+-]?0b[0-9]+`

十六进制整数的字母量格式如下：

1. 开始：+、-符号(可选)
2. 后跟：`0x`两个字符(必须)
3. 后跟：`0-9a-fA-F`字符的任意组合(至少一个字符)

用正则表达式表示`[+-]?0x[0-9]+`


### 浮点数

浮点数字面量格式如下：

1. 开始：+、-符号(可选)
2. 后跟：`0-9`的任意组合(可选)
3. 后跟：`.`(必须)
4. 后跟：`0-9`的任意组合(可选)  **注：2和4必须有一个有数值** `1., .1`都是浮点数
5. 后跟：可选项
    1. e或E（必须）
    2. 后跟：+、-符号(可选)
    3. 后跟：`0-9`的任意组合(至少一个字符)

用正则表达式表示为：`[+-]?(([0-9]+[.][0-9]*)|([0-9]*[.][0-9]+))[eE][+-]?[0-9]+` 

> 本文用`<float>`引用浮点数


### 复数

flang用j表示虚数符号。复数的文本形式为`1+2j, 1j, -1j`。

复数实部为浮点数或整数，虚部文本格式定义如下：

+ 开始：+-（可选）
+ 后跟：整数或浮点数（必须）
+ 结束：j（必须）

复数虚部用正则表达式表示为：`(<int>|<float>)j`

> 单独的j不是复数，可以作为变量。

### 转义字符

在字符、字符串中使用反斜杠\可以指定转义字符。转义字符中的\表示它后面的字符
已失去它原来的含义，转变成另外的特定含义。

转义字符格式如下：

+ `\'`: 单引号'
+ `\"`: 双引号"
+ `\\`: 反斜杠\
+ `\0`: 空字符Null
+ `\t`: 水平制表符
+ `\n`: 换行符Lf
+ `\r`: 回车符Cr
+ `\xhh`: 0-FF的字符转义（h表示1位十六进制数）
+ `\uhhhh`: 0-FFFF的字符转义（h表示1位十六进制数）
+ `\u{h+}`: 任意unicode字符转义（h+表示1到多位十六进制数）

> 反斜杠\后跟其他字符将会出现错误。

用正则表达式表示:`\\x[0-9a-fA-F]{2}|\\u[0-9a-fA-F]{4}|\\u\{[0-9a-fA-F]{1,8}\}`

> 本文用`<escape>`引用转义字符

### 字符

字符（Char）用于表示任意一个unicode字符，字面量用单引号 ' 括起来。
字符内的换行符必须是转义字符，其他字符可以是字符本身也可以用转义字符形式。格式如下：

1. 开始：单引号'（必须）
2. 后跟：任意字符，\<newline\>内包含的字符必须是转义字符形式，
其他字符也可以是转义字符形式（零或一个） 
3. 结束：单引号'（必须）

用正则表达式表示为：`'([^<newline>\\]?|<escape>)'`

> 本文用`<char>`引用单引号内的字符内容（不含单引号）

### 视觉字符

视觉字符（Character）表示一个unicode字形簇，即人视觉中的单个字形，
比如字母a与注音符号组成的一个字母。

视觉字符的字面量文本同样用单引号 ' 括起来。
与字符不同的地方在于可以用多个unicode字符表示一个字，格式如下：

1. 开始：单引号'（必须）
2. 后跟：任意字符，\<newline\>内包含的字符必须是转义字符形式（零个或一个）
3. 后跟修饰符字符：unicode类别M的字符（零个或多个，可以为转义字符）
4. 结束：单引号'（必须）

用正则表达式表示为：`'<char>(\p{M}|<escape>)*'`

>> 词法分析中，视觉字符文本内的转义字符只做格式检测，不做字符类别检测，
>> 语义分析时检查转义字符是否符合字符要求，比如控制字符、空白字符后不能跟修饰符。

### 字符串

字符串字面量文本有三种

+ 单行字符串：换行必须用转义字符
+ 多行字符串：换行保留，也可以用转义字符
+ 逐字字符串：换行保留，\被解释为字符，不转义

#### 单行字符串

单行字符串用双引号"括起来，格式如下：

1. 开始：双引号"（必须）
2. 后跟：任意多个字符，可以是转义字符（\<newline\>内包含的字符必须是转义字符）
4. 结束：双引号"（必须）

用正则表达式表示`"<char>*"`

> 本文用`<str>`引用字符串双引号内的内容(不含双引号)

#### 多行字符串

多行字符串用三个双引号或者三个单引号括起来。
内部可以使用转义字符，换行保留。

1. 开始："""或'''（必须）
2. 后跟：任意多个字符，或者转义字符
3. 结束：对应的"""或'''（必须）

用正则表达式表示为：`"""([^\\]|<escape>)*"""|'''([^\\]|<escape>)*'''`

> 本文用`<string>`引用多行字符串内不含三引号的字符内容

多行字符的缩进问题：比开始的三引号"""所在代码行缩进4个字符为标准缩进，标准缩进会被忽略。

示例：

~~~flang
var a = """this is the first line,
    this is the second line,
	    this is a line indented “4 chars”,
	this is a line didn't indented."""
~~~

> 上述代码第二行和第四行行首并不会保留空白。

在多行字符内可以使用单引号'、双引号"、两个单引号''、两个双引号""，
使用三个单引号定义字面量时，内部可以用三个或以上双引号，反之亦然。
例如：

~~~flang
let a = '''this is the first line,""""""",end'''
let b = """string in flang is in "", and char is in ''."""
~~~

**逐字字符串**

逐字字符串只需在单行字符串或多行字符串的引号前加上`@`字符。
逐字字符串内所有的反斜杠都不会被解释为转义字符，空格缩进同多行字符。

格式为：`@"<任意非换行符字符序列>"`或者`@"""<任意字符序列>"""`或者`@'''<任意字符序列>'''`

> 逐字字符串与多行字符串相比，单独的反斜杠也是合法的。

## 运算符号和标点符号

~~~
(	)	[	]	{	}	<	>
.	,	:	;	=	->	..	...	#	@
+	-	*	/	//	%	^	
!	||	&&  ~	|	&	⊕	<<	>>	>>>

+=	-=	*=	/=	//=	%=	^=
==	!=	===	!=== 	>=	<=	
~=	|=	&=	⊕=  <<=	>>=	>>>=
~~~

> 	unicode类别Sm，Sc作为预留符号，未来可能用于运算符号

## 注释

注释有两种格式：

单行注释是由//开始直到行尾的字符序列

多行注释是在/\*和\*/之间的字符序列。
多行注释可以嵌套，但是必须合理的嵌套。
因此像`/* /* */`这样的注释是非法的，因为有一个没有结束的注释。

> 注释中可以使用markdown语法文档。
> 文档注释以`///`开始，或者以`/**`开始。


## 预处理指令

~~~
#if #elif #else #endif
#embed #endembed
#region #endregion
~~~

## 附件：字符集说明

unicode编码类别来表示字符集的不同范围。unicode编码类别简单说明如下：

+ 字母
	+ Lu(UppercaseLetter): 大写字母。
	+ Ll(LowercaseLetter):	小写字母。
	+ Lt(TitlecaseLetter): 首字母大写字母(多字母组成的字母)。
	+ Lm(ModifierLetter): 修饰符字母，它是独立式的间距字符，指示前面字母的修改。
	+ Lo(OtherLetter): 其他字母（含cjk字等)。
+ 附加符号标记
	+ Mn(NonSpacingMark): 指示字符是非间距字符，这指示基字符的修改。
	+ Mc(SpacingCombiningMark): 指示字符是间距字符，这指示基字符的修改并影响
	该基字符的标志符号的宽度。
	+ Me(EnclosingMark): 指示字符是封闭符号，封闭符号是非间距组合字符，
	它环绕直到基字符（并包括基字符）的所有前面的字符。
+ 数字
	+ Nd(DecimalDigitNumber): 指示字符是十进制数字，即在范围0到9内数字的
	各种语言的表示。
	+ Nl(LetterNumber): 指示字符是由字母表示的数字，而不是十进制数字，
	如罗马数字 “I、II”，楔形数字，汉字中的“廿、卅”等。
	+ No(OtherNumber): 指示字符是数字，但它既不是十进制数字也不是字母数字，
	例如分数 1/2，带括号或圆的①㈠等。No中的౼和汉字一不是一个字符。
+ 标点
	+ Pc(ConnectorPunctuation): 指示字符是连接两个字符的连接符标点。
	如_︴︳等。其中︳与|不是同一个符号。
	+ Pd(DashPunctuation): 指示字符是短划线或连字符。如-᐀等。
	其中᐀跟等号=非常相似，部分符号和-非常相似。
	+ Ps(OpenPunctuation): 指示字符是成对的标点符号。
	如括号、方括号和大括号之一的开始字符。
	+ Pe(ClosePunctuation): 指示字符是成对的标点符号。
	如括号、方括号和大括号之一的封闭字符。
	+ Pi(InitialQuotePunctuation): 指示字符是开始或前引号。如«”等。
	+ Pf(FinalQuotePunctuation): 指示字符是封闭或后引号。与Pi对应。
	+ Po(OtherPunctuation): 指示字符是标点，但它不是连接符标点、短划线标点、
	开始标点、结束标点、	前引号标点或后引号标点。如！#\*&؞‱等
+ 符号
	+ Sm(MathSymbol): 指示字符是数学符号，例如“+”或“=”。
	+ Sc(CurrencySymbol): 指示字符是货币符号。
	+ Sk(ModifierSymbol): 指示字符是修饰符符号，这指示环绕字符的修改。
	例如，分数斜线号指示其左侧的数字为分子，右侧的数字为分母。
	+ So(OtherSymbol): 指示字符是符号，但它不是数学符号、货币符号或修饰符符号。
+ 分隔符
	+ Zs(SpaceSeparator): 指示字符是空白字符，它不具有标志符号，
	但不是控制或格式字符。
	+ Zl(LineSeparator): 指示字符用于分隔文本各行。
	+ Zp(ParagraphSeparator): 指示字符用于分隔段落。
+ 控制字符
	+ Cc(Control): 指示字符是控制代码，其 unicode 值是 U+007F，
	或者位于 U+0000 到 U+001F 或 U+0080 到 U+009F 范围内。
	+ Cf(Format): 指示字符是格式字符，格式字符是通常不呈现的字符，
	但它影响文本布局或文本处理操作。
	+ Cs(Surrogate): 指示字符是高代理项还是低代理项。
	代理项代码值在范围 U+D800 到 U+DFFF 内。
	+ Co(PrivateUse): 指示字符是专用字符，其 unicode 值在
	范围 U+E000 到 U+F8FF 内。
	+ Cn(OtherNotAssigned): 指示字符未被分配给任何unicode类别。
